{% extends 'base.html' %}

{% block content %}
    <main>
        <div class="search text-center">
            <div class="container">
                <div class="s004">
                  <form>
                    <fieldset>
                      <legend>CZEGO SZUKASZ?</legend>
                        <p id="wpisz">Wpisz lub Dodaj plik tekstowy</p>

                      <div class="dropzone" id="plik" hidden="hidden">
                        <div class="dz-message needsclick">
                            <h1>Upuść pliki tutaj lub kliknij, aby przesłać.</h1>
                        </div>
                      </div>

                      <div>

                      </div>
                      <div class="inner-form" id="tekst">
                        <div class="input-field">
                          <input class="form-control" id="choices-text-preset-values" type="text" placeholder="Type to search..." />
                          <button class="btn-search" type="button" onclick="search()">
                            <i class="fa-solid fa-magnifying-glass"></i>
                          </button>
                        </div>
                      </div>
                        <a type="button" id="guzikzamiany" onclick="zmiana();">Plik <i class="fa-solid fa-upload"></i> </a>
                        <button type="button" class="b" id="guzikplik" hidden onclick="searchbyfile()">
                            Wyszukaj
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </button>
                    </fieldset>
                  </form>
                </div>
            </div>
        </div>

        <div class="container main list" id="list">
            <div class="col-md-3">
                <section class="panel">
                    <header class="panel-heading">
                        Posortuj według:
                    </header>
                    <div class="section-body">
                        <ul class="menu-list">
                          <li class="menu-group"><a class="text-underlined">Ceny</a></li>
                          <li class="menu-group"><a class="text-underlined">Nazwy</a></li>
                        </ul>
                    </div>
                </section>
                <section class="panel">
                    <header class="panel-heading">
                    </header>
                </section>
            </div>

            <div class="list-panel" id="centered">
            </div>
        </div>
    </main>
{% endblock %}

{% block scripts %}

<script src="https://kit.fontawesome.com/05a09beaf0.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" type="text/css" />
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
<script>
    products = [];

    $(document).ready(function(){
        $(".dropzone").dropzone({
          url: '/upload',
          width: 300,
          height: 300,
          progressBarWidth: '100%',
          maxFileSize: '5MB',
          maxFiles: 1,
          acceptedFiles: '.txt'
        })
    });

      let zmiana = () => {
          let x = document.getElementById("plik");
          let y = document.getElementById("tekst");
          let btn = document.getElementById("guzikzamiany");
          let btn1 = document.getElementById("guzikplik");
          let hidden = x.getAttribute("hidden");
          if (hidden) {
            y.setAttribute("hidden", "hidden");
            x.removeAttribute("hidden");
            btn.innerText="Tekst";
            btn1.removeAttribute("hidden");
          } else {
            y.removeAttribute("hidden");
            x.setAttribute("hidden", "hidden");
            btn1.setAttribute("hidden", "hidden");
            btn.innerHTML="Plik " + `<i class="fa-solid fa-upload"></i>`;
          }
        }

      var textPresetVal = new Choices('#choices-text-preset-values',
      {
        removeItemButton: true,
      });

      function convert(items){
          var rows = [];
          for (var key in items) {
              var row = items[key];
              rows.push({
                LP: row.ID,
                img_src: `<img src="${row.img_src}">`,
                nazwa: row.nazwa,
                sklep: row.sklep,
                cena: row.cena
              });
            }
          return rows
      }


      function robienietabeli(){
          let table = document.createElement('table');
          table.setAttribute("id", "tabelawynikow")
          let headerRow = document.createElement('tr');
          let headerID = document.createElement('th');
          headerID.textContent = 'LP.';
          headerRow.appendChild(headerID);
          let headerimg = document.createElement('th');
          headerimg.textContent = 'Fotko';
          headerRow.appendChild(headerimg);
          let headerName = document.createElement('th');
          headerName.textContent = 'Nazwa';
          headerRow.appendChild(headerName);
          let headerSklep = document.createElement('th');
          headerSklep.textContent = 'Sklep';
          headerRow.appendChild(headerSklep);
          let headerValue = document.createElement('th');
          headerValue.textContent = 'Cena';
          headerRow.appendChild(headerValue);
          table.appendChild(headerRow);
          document.getElementById("centered").appendChild(table);
      }

      function dodawanieDoTabeli(items){
          if (document.getElementById('tabelawynikow') == null){
              robienietabeli()
          }
          let table = document.getElementById('tabelawynikow');
            for (let i = 0; i < items.length; i++) {
              let row = document.createElement('tr');
              let IDCell = document.createElement('td');
              IDCell.textContent = items[i].ID;
              row.appendChild(IDCell);
              let imgCell = document.createElement('td');
              var imgElement = document.createElement('img');
              imgElement.src = items[i].img_src;
              imgCell.appendChild(imgElement)
              row.appendChild(imgCell);
              let nameCell = document.createElement('td');
              nameCell.textContent = items[i].nazwa;
              row.appendChild(nameCell);
              let sklepCell = document.createElement('td');
              sklepCell.textContent = items[i].sklep;
              row.appendChild(sklepCell);
              let valueCell = document.createElement('td');
              valueCell.textContent = items[i].cena;
              row.appendChild(valueCell);
              table.appendChild(row);
            }
      }

      function searchbyfile(){
          const mydiv = document.getElementById("list");
          mydiv.style.display = "block";
          const params = {params: null}
          fetch('/ceneo', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(
                params,
            )
          })
          .then(response => response.json())
          .then(lista => {
              findproduct(lista)
          });
      }

      function findproduct(lista){
          let params = lista["nazwy"]
          console.log(params)
          console.log(lista)
              if (lista['znalezione'] != undefined) {
                  for (let i = 0; i <= lista['znalezione'].length; i++) {
                      if (lista['znalezione'][i] != undefined)
                          products.push(lista['znalezione'][i]);
                  }
              }
              if (Object. keys(lista['nieznalezione']).length != 0) {
                  for (let hwdp = 0; hwdp < params.length; hwdp++) {
                      console.log(lista['nieznalezione'][params[hwdp]])
                      if (lista['nieznalezione'][params[hwdp]] != undefined) {
                          createname(params[hwdp]);
                          var xd = lista['nieznalezione'][params[hwdp]]
                          createTable(Object.keys(xd).length, xd);
                          }
                          }
              }
              robienietabeli()
              dodawanieDoTabeli(products)
      }

      function createTable(rows, json) {
          var table = document.createElement('table');
          table.setAttribute("id", "table");
          var tbody = document.createElement('tbody');
          for (var i = 0; i < rows-1; i=i+2) {
            if (i == 10 || i == 0) {
                var tr = document.createElement('tr');
            }
            var td = document.createElement('td');
            var button = document.createElement('button');
            button.className = 'btn-primary';
            button.setAttribute('role', 'button');
            const key = `num${i+1}`;
            const img = `num${i}`;
            button.id = json[key].toString().replace(' ','-');
            button.setAttribute('nazwa', json[key])
            button.innerHTML = `<img src="${json[img]}">` + `<br>` + json[key];
            button.onclick = function() {
                searchv2(this.id);
            };
            td.appendChild(button);
            tr.appendChild(td);
            tbody.appendChild(tr);
          }
          table.appendChild(tbody);
          document.getElementById("centered").appendChild(table);
        }


      function search(){
          const mydiv = document.getElementById("list");
          mydiv.style.display = "block";
          let params = {params: document.getElementById("choices-text-preset-values").value};
          fetch('/ceneo', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(
                params,
            )
          })
          .then(response => response.json())
          .then(lista => {
              findproduct(lista)
          });
        }

      function createname(stringi){
          var xd = document.createElement('div')
          xd.setAttribute("align", "center")
          xd.setAttribute("id", "mytable")
          var xd2 = document.createElement('h4')
          xd2.innerHTML = `Wybierz jedną z opcji, ponieważ hasło ${stringi} nie jest wystarczające`
          xd.appendChild(xd2)
          document.getElementById("centered").appendChild(xd);
      }

      function searchv2(clicked_id){
          const params2 = {params: document.getElementById(clicked_id).getAttribute('nazwa')};
          deleteExisting()
          fetch('/ceneo', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(
                    params2,
                )
              })
              .then(response => response.json())
              .then(lista => {
                  if (lista['znalezione'] != undefined) {
                  for (let i = 0; i <= lista['znalezione'].length; i++) {
                      console.log(products)
                      if (lista['znalezione'][i] != undefined){
                          if (products.length != 0) {
                              console.log('xd')
                              lista['znalezione'][i].ID = products[products.length - 1].ID + 1
                          }
                          products.push(lista['znalezione'][i])
                      }
                  }
                  deletetab()
                  dodawanieDoTabeli(products)
              }
                  if (Object. keys(lista['nieznalezione']).length != 0) {
                    for (let hwdp = 0; hwdp < params.length; hwdp++) {
                      console.log(lista['nieznalezione'][params[hwdp]])
                      if (lista['nieznalezione'][params[hwdp]] != undefined) {
                          createname(params[hwdp]);
                          var xd = lista['nieznalezione'][params[hwdp]]
                          createTable(Object.keys(xd).length, xd);
                          }
                          }
                    }
              });
      }
    function deleteExisting() {
            $("#mytable").remove();
            $("#table").remove();
        }
    function deletetab() {
          $("#tabelawynikow").remove();
    }
    </script>
{% endblock %}
